name: CI

on:
  push:

jobs:
  build-wheel:
    name: "ğŸ—ï¸ Python wheel"
    strategy:
      matrix:
        os:
          - ubuntu-latest
#          - macos-latest
#          - windows-latest
        python:
          - 3.8
          - 3.9
    runs-on: ${{ matrix.os }}
    steps:
      - name: "ğŸ“¥ Check-out"
        uses: actions/checkout@v2
      - name: "ğŸ§° Install Python"
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python }}
          cache: pip
      - name: "ğŸ§° Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      - name: "ğŸ—ï¸ Build Python wheel"
        run: python -m build
      - name: "ğŸ“¤ Upload Python wheel"
        uses: actions/upload-artifact@v2
        with:
          path: talk/short-talk.pdf
          name: Wheel (${{ matrix.python }}, ${{ matrix.os }})
  code-format:
    name: "ğŸ” Python code format"
    needs:
      - build-wheel
    strategy:
      matrix:
        os:
          - ubuntu-latest
#          - macos-latest
#          - windows-latest
        python:
          - 3.8
          - 3.9
    runs-on: ${{ matrix.os }}
    steps:
      - name: "ğŸ“¥ Check-out"
        uses: actions/checkout@v2
      - name: "ğŸ§° Install Python"
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python }}
          cache: pip
      - name: "ğŸ§° Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -e .[test]
      - name: "ğŸ” Check Python code format"
        run: flake8
  lint:
    name: "ğŸ” Python Lint"
    needs:
      - build-wheel
    strategy:
      matrix:
        os:
          - ubuntu-latest
#          - macos-latest
#          - windows-latest
        python:
          - 3.8
          - 3.9
    runs-on: ${{ matrix.os }}
    steps:
      - name: "ğŸ“¥ Check-out"
        uses: actions/checkout@v2
      - name: "ğŸ§° Install Python"
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python }}
          cache: pip
      - name: "ğŸ§° Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -e .[test]
      - name: "ğŸ” Lint Python code"
        run: pylint -E ir_axioms
  unit-tests:
    name: "ğŸ§ª Python unit tests"
    needs:
      - build-wheel
    strategy:
      matrix:
        os:
          - ubuntu-latest
#          - macos-latest
#          - windows-latest
        python:
          - 3.8
          - 3.9
    runs-on: ${{ matrix.os }}
    steps:
      - name: "ğŸ“¥ Check-out"
        uses: actions/checkout@v2
      - name: "ğŸ§° Install Python"
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python }}
          cache: pip
      - name: "ğŸ§° Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -e .[test]
      - name: "ğŸ§ª Test Python code"
        run: pytest --ignore=tests/integration/
  integration-tests:
    name: "ğŸ§ª Python integration tests"
    needs:
      - build-wheel
    strategy:
      matrix:
        os:
          - ubuntu-latest
#          - macos-latest
#          - windows-latest
        python:
          - 3.8
          - 3.9
        backend:
          - pyserini
          - pyterrier
    runs-on: ${{ matrix.os }}
    steps:
      - name: "ğŸ“¥ Check-out"
        uses: actions/checkout@v2
      - name: "ğŸ§° Install Python"
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python }}
          cache: pip
      - name: "ğŸ§° Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -e .[test]
          pip install ${{ matrix.backend }}
      - name: "ğŸ§° Install Pyserini"
        run: pip install pyserini
        if: ${{ matrix.backend == 'pyserini' }}
      - name: "ğŸ§° Install PyTerrier"
        run: pip install python-terrier
        if: ${{ matrix.backend == 'pyterrier' }}
      - name: "ğŸ§ª Test Python code"
        run: pytest tests/integration/test_${{ matrix.backend }}.py
